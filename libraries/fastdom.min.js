!function(t){"use strict";function e(){this.frames=[],this.lastId=0,this.raf=i,this.batch={hash:{},read:[],write:[],mode:null}}var i=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/60)};e.prototype.read=function(t,e){var i=this.add("read",t,e),h=i.id;this.batch.read.push(i.id);var n="reading"===this.batch.mode||this.batch.scheduled;return n?h:(this.scheduleBatch(),h)},e.prototype.write=function(t,e){var i=this.add("write",t,e),h=this.batch.mode,n=i.id;this.batch.write.push(i.id);var r="writing"===h||"reading"===h||this.batch.scheduled;return r?n:(this.scheduleBatch(),n)},e.prototype.defer=function(t,e,i){"function"==typeof t&&(i=e,e=t,t=1);var h=this,n=t-1;return this.schedule(n,function(){h.run({fn:e,ctx:i})})},e.prototype.clear=function(t){if("function"==typeof t)return this.clearFrame(t);t=Number(t);var e=this.batch.hash[t];if(e){var i=this.batch[e.type],h=i.indexOf(t);delete this.batch.hash[t],~h&&i.splice(h,1)}},e.prototype.clearFrame=function(t){var e=this.frames.indexOf(t);~e&&this.frames.splice(e,1)},e.prototype.scheduleBatch=function(){var t=this;this.schedule(0,function(){t.batch.scheduled=!1,t.runBatch()}),this.batch.scheduled=!0},e.prototype.uniqueId=function(){return++this.lastId},e.prototype.flush=function(t){for(var e;e=t.shift();)this.run(this.batch.hash[e])},e.prototype.runBatch=function(){try{this.batch.mode="reading",this.flush(this.batch.read),this.batch.mode="writing",this.flush(this.batch.write),this.batch.mode=null}catch(t){throw this.runBatch(),t}},e.prototype.add=function(t,e,i){var h=this.uniqueId();return this.batch.hash[h]={id:h,fn:e,ctx:i,type:t}},e.prototype.run=function(t){var e=t.ctx||this,i=t.fn;if(delete this.batch.hash[t.id],!this.onError)return i.call(e);try{i.call(e)}catch(h){this.onError(h)}},e.prototype.loop=function(){var t=this,e=this.raf;this.looping||(e(function i(){var h=t.frames.shift();t.frames.length?e(i):t.looping=!1,h&&h()}),this.looping=!0)},e.prototype.schedule=function(t,e){return this.frames[t]?this.schedule(t+1,e):(this.loop(),this.frames[t]=e)},t=t||new e,"undefined"!=typeof module&&module.exports?module.exports=t:"function"==typeof define&&define.amd?define(function(){return t}):window.fastdom=t}(window.fastdom);
