function ready(e){"loading"!=document.readyState?e():document.addEventListener("DOMContentLoaded",e)}function getJSON(e){return new Promise(function(t,n){var o=new XMLHttpRequest;o.open("GET",e,!0),o.onload=function(){if(o.status>=200&&o.status<400){var e=JSON.parse(o.responseText);t(e)}else n()},o.onerror=function(){n()},o.send()})}function ajax(e){return new Promise(function(t,n){var o=new XMLHttpRequest;o.open("GET",e,!0),o.onload=function(){if(o.status>=200&&o.status<400){var e=o.responseText;t(e)}else n()},o.onerror=function(){},o.send()})}function addClass(e,t){""!=t&&(e.classList?e.classList.add(t):e.className+=" "+t)}function removeClass(e,t){""!=t&&(e.classList?e.classList.remove(t):e.className=e.className.replace(new RegExp("(^|\\b)"+t.split(" ").join("|")+"(\\b|$)","gi")," "))}function hasClass(e,t){return""!=t?e.classList?e.classList.contains(t):new RegExp("(^| )"+t+"( |$)","gi").test(e.className):void 0}function readDOM(e,t){fastdom.read(t,window.ui[e])}function readDOMel(e,t){fastdom.read(t,e)}function updateDOM(e,t){fastdom.write(t,window.ui[e])}function updateDOMel(e,t){fastdom.write(t,e)}function addToHash(e){location.hash=location.hash+e}function animate(e,t,n){window.animating.push([e,t,n]),1===window.animating.length&&checkAnimQueue()}function checkAnimQueue(){var e=window.animating[0];null===e||void 0===e||actualAnimate(e[0],e[1],e[2]).then(function(){window.animating.shift()}).then(checkAnimQueue)}function actualAnimate(e,t,n){function o(){var e,t={transtion:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(e in t)if(void 0!==i.style[e])return t[e]}var i=window.ui[e];return new Promise(function(e,a){fastdom.read(function(){var a=o();fastdom.write(function(){"a"===n?hasClass(i,t)?e():addClass(i,t):hasClass(i,t)?removeClass(i,t):e()}),a&&i.addEventListener(a,function(){e()})})})}function isSmallScreen(){return window.viewport<520}function isElementInViewport(e){var t=e.getBoundingClientRect();return t.top>=0}function convertVH(e){var t=parseInt((window.getComputedStyle?getComputedStyle(e,null):e.currentStyle).height,10);window.viewportHeight!==t&&(e.style.height=window.viewportHeight+"px")}window.pagetitle=function(){var e=document.getElementById("page-title"),t=function(){switch(window.state.page){case"book":return getBookAttribute(window.state.selectedbook,"shortname");case"bookchapter":return getBookAttribute(window.state.selectedbook,"shortname");default:return"Tidy Classics"}},n=function(){updateDOMel(e,function(){document.title=t(),this.innerHTML=t()})};return{update:n}}(),window.booknav=function(){var e=document.getElementById("book-nav-overlay"),t=document.getElementById("nav-center"),n=document.getElementById("book-nav"),o=document.getElementById("book-nav-toggle");return{update:function(e,t){t=parseInt(t);var o=[["Table Of Contents","#book/"+e]];t>1&&o.push(["Previous Chapter","#book/"+e+"/chapter/"+(t-1)]),getBookAttribute(e,"toc").length>t&&o.push(["Next Chapter","#book/"+e+"/chapter/"+(t+1)]),displaylist=[];for(var i=0,a=o.length;a>i;i++)displaylist.push("<li><a href='"+o[i][1]+"'>"+o[i][0]+"</a></li>");displaylist.push("<li onclick='bookmark()'><span>Bookmark</span></li>"),updateDOMel(n,function(){this.innerHTML=displaylist.join("")})},show:function(){updateDOMel(o,function(){this.checked=!0}),updateDOMel(e,function(){addClass(this,"overlay-visible")}),updateDOMel(t,function(){addClass(this,"nav-item-selected")}),updateDOMel(n,function(){addClass(n,"slide-in")})},hide:function(){updateDOMel(o,function(){this.checked=!1}),updateDOMel(e,function(){removeClass(this,"overlay-visible")}),updateDOMel(t,function(){removeClass(t,"nav-item-selected")}),updateDOMel(n,function(){removeClass(n,"slide-in")})},disable:function(){updateDOMel(o,function(){this.disabled=!0})},enable:function(){updateDOMel(o,function(){this.disabled=!1})}}}(),window.player=function(){function e(){updateDOMel(s,function(){window.state.autoplay?this.innerHTML="ON":this.innerHTML="OFF"})}var t=document.getElementById("player-overlay"),n=document.getElementById("nav-right"),o=document.getElementById("audio-player-container"),i=document.getElementById("player-toggle-label"),a=document.getElementById("audio-player"),s=document.getElementById("autoplay-state"),l=function(e,t){t=parseInt(t);var n=getBookAttribute(e,"toc");p()!==n[t].audio&&f(n[t].audio),window.state.autoplay&&m()},u=function(){updateDOMel(t,function(){addClass(this,"overlay-visible")}),updateDOMel(n,function(){addClass(this,"nav-item-selected")}),updateDOMel(o,function(){addClass(o,"slide-in")})},d=function(){updateDOMel(t,function(){removeClass(this,"overlay-visible")}),updateDOMel(n,function(){removeClass(n,"nav-item-selected")}),updateDOMel(o,function(){removeClass(o,"slide-in")})},r=function(){updateDOMel(i,function(){addClass(this,"hidden")})},c=function(){updateDOMel(i,function(){removeClass(this,"hidden")})},p=function(){return a.plyr.media.src},f=function(e){a.plyr.source(e)},h=function(){return 0!==a.plyr.media.currentTime},m=function(){a.plyr.play()};return s.addEventListener("click",function(){window.state.autoplay=!window.state.autoplay,e()}),a.plyr.media.onended=function(){window.state.autoplay&&getTOC(window.state.selectedbook).then(function(e){window.state.currentChapter<e.length&&(document.location.hash="#book/"+window.state.selectedbook+"/chapter/"+(window.state.currentChapter+1))})},e(),{update:l,show:u,hide:d,disable:r,enable:c,getSource:p,setSource:f,isPlaying:h,play:m}}(),window.booklist=function(){var e=document.getElementById("book-list-template").innerHTML;Mustache.parse(e);var t=document.getElementById("book-list");return{display:function(n){for(var o=[],i=0,a=n.length;a>i;i++)o.push(window.state.booklist[n[i]]);updateDOMel(t,function(){this.innerHTML=Mustache.render(e,{list:o})})}}}(),window.booktoc=function(){var e=document.getElementById("toc-template").innerHTML;Mustache.parse(e);var t=document.getElementById("book-toc");return{display:function(n){for(var o=getBookAttribute(n,"toc"),i=[],a=location.hash,s=0,l=o.length;l>s;s++)i.push(o[s]),i[s].href=a+"/chapter/"+o[s].idx;updateDOMel(t,function(){this.innerHTML=Mustache.render(e,{list:i})})}}}(),window.bookchapter=function(){var e=document.getElementById("book-inner"),t=document.getElementById("page-total"),n=new showdown.Converter,o=function(){updateDOMel(t,function(){removeClass(this,"hidden")})},i=function(){updateDOMel(t,function(){addClass(this,"hidden")})},a=function(e){updateDOMel(t,function(){this.innerHTML=e+" pages"})},s=function(t,o,i){a(Math.round(t.length/2600)),t=isSmallScreen()?t.replace(/([a-zA-Z0-9]+).jpg/g,"$1-sm.jpg"):t.replace(/([a-zA-Z0-9]+).jpg/g,"$1-md.jpg");for(var s=n.makeHtml(t).split("<p>"),l=getBookAttribute(window.state.selectedbook,"dropcapclass"),u=1;u<s.length;)"<"!==s[u][0]&&('"'==s[u][0]?s[u]="<span style='float:left;'>&quot;</span><span class='dropcap "+l+"'>"+s[u][1]+"</span>"+s[u].slice(2):s[u]="<span class='dropcap "+l+"'>"+s[u][0]+"</span>"+s[u].slice(1),u=s.length),u++;s=s.join("<p>"),s=s.replace(/<blockquote>/g,"<blockquote><pre>"),s=s.replace(/<\/blockquote>/g,"</pre></blockquote>"),getBookAttribute(window.state.selectedbook,"captions")&&(s=s.replace(/(<img .* alt="(.*?)".*\/>)/g,"<figure>$1<figcaption>$2</figcaption></figure>"));var d=getBookAttribute(window.state.selectedbook,"toc");window.state.currentChapter<d.length&&(s=s+"<a class='next-chapter-link' href='#book/"+window.state.selectedbook+"/chapter/"+(i+1).toString()+"'>Next Chapter</a>"),updateDOMel(e,function(){if(this.innerHTML=s,o){var e=this.getElementsByTagName("p");e[o].scrollIntoView(!0)}})},l=function(t){updateDOMel(e,function(){this.scrollTop=t})},u=function(){for(var t=e.getElementsByTagName("p"),n=0,o=t.length;o>n&&(el=t[n],!isElementInViewport(el));n++);return n};return{showPageTotal:o,hidePageTotal:i,update:s,updateScrollPos:l,getCurrentPos:u}}();